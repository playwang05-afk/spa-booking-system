<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPAé ç´„è¡¨å–® - Firebaseæ•´åˆ</title>
</head>
<body>
    <!-- ä½ çš„é ç´„è¡¨å–® HTML -->
    <form id="bookingForm">
        <div class="form-group">
            <label for="customerName">å®¢æˆ¶å§“å:</label>
            <input type="text" id="customerName" name="customerName" required>
        </div>
        
        <div class="form-group">
            <label for="customerPhone">è¯çµ¡é›»è©±:</label>
            <input type="tel" id="customerPhone" name="customerPhone" required>
        </div>
        
        <div class="form-group">
            <label for="customerEmail">é›»å­éƒµä»¶:</label>
            <input type="email" id="customerEmail" name="customerEmail">
        </div>
        
        <div class="form-group">
            <label for="service">æœå‹™é …ç›®:</label>
            <select id="service" name="service" required>
                <option value="">è«‹é¸æ“‡æœå‹™</option>
                <option value="ç¶“å…¸å¤šç‰¹ç‘èŠ³ç™‚æŒ‰æ‘©">ç¶“å…¸å¤šç‰¹ç‘èŠ³ç™‚æŒ‰æ‘© - $2800</option>
                <option value="æ·±å±¤çµ„ç¹”æŒ‰æ‘©">æ·±å±¤çµ„ç¹”æŒ‰æ‘© - $2200</option>
                <option value="æ”¾é¬†ç²¾æ²¹æŒ‰æ‘©">æ”¾é¬†ç²¾æ²¹æŒ‰æ‘© - $2500</option>
                <option value="ç‘å…¸å¼æŒ‰æ‘©">ç‘å…¸å¼æŒ‰æ‘© - $2000</option>
                <option value="ç†±çŸ³æŒ‰æ‘©">ç†±çŸ³æŒ‰æ‘© - $3200</option>
                <option value="å­•å©¦å°ˆç”¨æŒ‰æ‘©">å­•å©¦å°ˆç”¨æŒ‰æ‘© - $2400</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="therapist">é¸æ“‡æŒ‰æ‘©å¸«:</label>
            <select id="therapist" name="therapist" required>
                <option value="">è«‹é¸æ“‡æŒ‰æ‘©å¸«</option>
                <option value="æ—ç¾ç‰">æ—ç¾ç‰ - è³‡æ·±èŠ³ç™‚å¸«</option>
                <option value="é™³é›…æ–‡">é™³é›…æ–‡ - æ·±å±¤æŒ‰æ‘©å°ˆå®¶</option>
                <option value="å¼µæ…§å¨Ÿ">å¼µæ…§å¨Ÿ - å­•å©¦æŒ‰æ‘©å°ˆå®¶</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="bookingDate">é ç´„æ—¥æœŸ:</label>
            <input type="date" id="bookingDate" name="bookingDate" required>
        </div>
        
        <div class="form-group">
            <label for="bookingTime">é ç´„æ™‚é–“:</label>
            <select id="bookingTime" name="bookingTime" required>
                <option value="">è«‹é¸æ“‡æ™‚é–“</option>
                <option value="09:00">09:00 AM</option>
                <option value="10:30">10:30 AM</option>
                <option value="12:00">12:00 PM</option>
                <option value="13:30">01:30 PM</option>
                <option value="15:00">03:00 PM</option>
                <option value="16:30">04:30 PM</option>
                <option value="18:00">06:00 PM</option>
                <option value="19:30">07:30 PM</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="specialRequests">ç‰¹æ®Šéœ€æ±‚/å‚™è¨»:</label>
            <textarea id="specialRequests" name="specialRequests" rows="4" placeholder="å¦‚æœ‰ä»»ä½•ç‰¹æ®Šéœ€æ±‚è«‹å‘ŠçŸ¥..."></textarea>
        </div>
        
        <!-- æäº¤æŒ‰éˆ• -->
        <button type="submit" id="submitBtn">
            <span id="submitText">æäº¤é ç´„</span>
            <span id="loadingText" style="display: none;">è™•ç†ä¸­...</span>
        </button>
    </form>
    
    <!-- ç‹€æ…‹è¨Šæ¯é¡¯ç¤ºå€ -->
    <div id="statusMessage" style="display: none;"></div>
    
    <!-- Firebase SDK å’Œæ•´åˆä»£ç¢¼ -->
    <script type="module">
        // ==================== Firebase é…ç½® ====================
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // ğŸ”¥ è«‹æ›¿æ›ç‚ºä½ çš„ Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "your-api-key-here",
            authDomain: "purple-spa-booking.firebaseapp.com",
            projectId: "purple-spa-booking",
            storageBucket: "purple-spa-booking.appspot.com",
            messagingSenderId: "your-sender-id",
            appId: "your-app-id"
        };

        // åˆå§‹åŒ– Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        console.log("âœ… Firebase å·²é€£æ¥æˆåŠŸï¼");

        // ==================== è¡¨å–®æäº¤è™•ç† ====================
        document.getElementById('bookingForm').addEventListener('submit', async function(e) {
            e.preventDefault(); // é˜²æ­¢è¡¨å–®é è¨­æäº¤
            
            // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
            showLoading(true);
            
            try {
                // æ”¶é›†è¡¨å–®è³‡æ–™
                const formData = collectFormData();
                
                // é©—è­‰å¿…å¡«æ¬„ä½
                if (!validateFormData(formData)) {
                    showMessage('è«‹å¡«å¯«æ‰€æœ‰å¿…å¡«æ¬„ä½', 'error');
                    showLoading(false);
                    return;
                }
                
                // æäº¤åˆ° Firebase
                const bookingId = await submitToFirebase(formData);
                
                // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                showSuccessMessage(bookingId);
                
                // é‡ç½®è¡¨å–®
                document.getElementById('bookingForm').reset();
                
            } catch (error) {
                console.error('é ç´„æäº¤éŒ¯èª¤:', error);
                showMessage('é ç´„å¤±æ•—ï¼š' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        });

        // ==================== è¼”åŠ©å‡½æ•¸ ====================
        
        // æ”¶é›†è¡¨å–®è³‡æ–™
        function collectFormData() {
            return {
                customerName: document.getElementById('customerName').value.trim(),
                customerPhone: document.getElementById('customerPhone').value.trim(),
                customerEmail: document.getElementById('customerEmail').value.trim(),
                service: document.getElementById('service').value,
                therapist: document.getElementById('therapist').value,
                bookingDate: document.getElementById('bookingDate').value,
                bookingTime: document.getElementById('bookingTime').value,
                specialRequests: document.getElementById('specialRequests').value.trim(),
                status: 'å·²é ç´„',
                paymentStatus: 'å¾…ä»˜æ¬¾',
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp()
            };
        }
        
        // é©—è­‰è¡¨å–®è³‡æ–™
        function validateFormData(data) {
            const required = ['customerName', 'customerPhone', 'service', 'therapist', 'bookingDate', 'bookingTime'];
            
            for (let field of required) {
                if (!data[field]) {
                    console.log(`ç¼ºå°‘å¿…å¡«æ¬„ä½: ${field}`);
                    return false;
                }
            }
            
            // é©—è­‰æ—¥æœŸä¸èƒ½æ˜¯éå»
            const selectedDate = new Date(data.bookingDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (selectedDate < today) {
                showMessage('é ç´„æ—¥æœŸä¸èƒ½æ˜¯éå»çš„æ—¥æœŸ', 'error');
                return false;
            }
            
            return true;
        }
        
        // æäº¤åˆ° Firebase
        async function submitToFirebase(formData) {
            try {
                const docRef = await addDoc(collection(db, 'bookings'), formData);
                console.log("âœ… é ç´„è³‡æ–™å·²å„²å­˜ï¼Œæ–‡ä»¶ID:", docRef.id);
                
                // åŒæ™‚å„²å­˜åˆ°å®¢æˆ¶è³‡æ–™åº«ï¼ˆå¯é¸ï¼‰
                await saveCustomerInfo(formData);
                
                return docRef.id;
            } catch (error) {
                throw new Error('è³‡æ–™åº«å„²å­˜å¤±æ•—: ' + error.message);
            }
        }
        
        // å„²å­˜å®¢æˆ¶è³‡è¨Šï¼ˆå¯é¸åŠŸèƒ½ï¼‰
        async function saveCustomerInfo(formData) {
            try {
                const customerData = {
                    name: formData.customerName,
                    phone: formData.customerPhone,
                    email: formData.customerEmail,
                    lastVisit: serverTimestamp(),
                    totalBookings: 1 // å¯¦éš›æ‡‰è©²æŸ¥è©¢ä¸¦ç´¯åŠ 
                };
                
                // é€™è£¡å¯ä»¥æª¢æŸ¥å®¢æˆ¶æ˜¯å¦å·²å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨å°±æ›´æ–°ï¼Œä¸å­˜åœ¨å°±æ–°å¢
                await addDoc(collection(db, 'customers'), customerData);
                console.log("âœ… å®¢æˆ¶è³‡è¨Šå·²æ›´æ–°");
            } catch (error) {
                console.warn("å®¢æˆ¶è³‡è¨Šå„²å­˜å¤±æ•—ï¼ˆä¸å½±éŸ¿é ç´„ï¼‰:", error);
            }
        }
        
        // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
        function showSuccessMessage(bookingId) {
            const message = `
                ğŸ‰ é ç´„æˆåŠŸï¼
                é ç´„ç·¨è™Ÿï¼š${bookingId}
                
                æˆ‘å€‘æœƒç›¡å¿«èˆ‡æ‚¨è¯ç¹«ç¢ºèªé ç´„è©³æƒ…ã€‚
                æ„Ÿè¬æ‚¨é¸æ“‡æˆ‘å€‘çš„æœå‹™ï¼
            `;
            
            showMessage(message, 'success');
            
            // å¯é¸ï¼šè‡ªå‹•è·³è½‰åˆ°æˆåŠŸé é¢
            // setTimeout(() => {
            //     window.location.href = '/booking-success.html?id=' + bookingId;
            // }, 3000);
        }
        
        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        function showLoading(isLoading) {
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const loadingText = document.getElementById('loadingText');
            
            if (isLoading) {
                submitBtn.disabled = true;
                submitText.style.display = 'none';
                loadingText.style.display = 'inline';
            } else {
                submitBtn.disabled = false;
                submitText.style.display = 'inline';
                loadingText.style.display = 'none';
            }
        }
        
        // é¡¯ç¤ºè¨Šæ¯
        function showMessage(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = `status-message ${type}`;
            statusDiv.style.display = 'block';
            
            // 5ç§’å¾Œè‡ªå‹•éš±è—
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // ==================== é¡å¤–åŠŸèƒ½ ====================
        
        // è¨­å®šæœ€å°æ—¥æœŸç‚ºä»Šå¤©
        document.getElementById('bookingDate').min = new Date().toISOString().split('T')[0];
        
        // æ ¹æ“šé¸æ“‡çš„æœå‹™è‡ªå‹•è¨ˆç®—åƒ¹æ ¼ï¼ˆå¯é¸ï¼‰
        document.getElementById('service').addEventListener('change', function() {
            const service = this.value;
            const priceMap = {
                'ç¶“å…¸å¤šç‰¹ç‘èŠ³ç™‚æŒ‰æ‘©': 2800,
                'æ·±å±¤çµ„ç¹”æŒ‰æ‘©': 2200,
                'æ”¾é¬†ç²¾æ²¹æŒ‰æ‘©': 2500,
                'ç‘å…¸å¼æŒ‰æ‘©': 2000,
                'ç†±çŸ³æŒ‰æ‘©': 3200,
                'å­•å©¦å°ˆç”¨æŒ‰æ‘©': 2400
            };
            
            if (priceMap[service]) {
                console.log(`é¸æ“‡æœå‹™: ${service}, åƒ¹æ ¼: $${priceMap[service]}`);
                // é€™è£¡å¯ä»¥é¡¯ç¤ºåƒ¹æ ¼çµ¦ç”¨æˆ¶çœ‹
            }
        });

        // å…¨åŸŸå‡½æ•¸ï¼Œä¾›å…¶ä»–è…³æœ¬ä½¿ç”¨
        window.SpaBooking = {
            // æŸ¥è©¢é ç´„è¨˜éŒ„
            async getBookings() {
                try {
                    const querySnapshot = await getDocs(collection(db, 'bookings'));
                    const bookings = [];
                    querySnapshot.forEach((doc) => {
                        bookings.push({ id: doc.id, ...doc.data() });
                    });
                    return bookings;
                } catch (error) {
                    console.error('æŸ¥è©¢é ç´„å¤±æ•—:', error);
                    throw error;
                }
            },
            
            // æ‰‹å‹•æäº¤é ç´„ï¼ˆAPIï¼‰
            async submitBooking(bookingData) {
                return await submitToFirebase(bookingData);
            }
        };
    </script>

    <!-- CSS æ¨£å¼ -->
    <style>
        .status-message {
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            font-weight: bold;
        }
        
        .status-message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        #submitBtn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        
        button:hover:not(:disabled) {
            background-color: #0056b3;
        }
    </style>
</body>
</html>
